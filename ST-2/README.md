# ST-2 リリース ノート

## ゲーム概要
  - 縦シュー習作. 全ステージ クリアしたらエンディングです
  - 敵をなぎ倒す快感を重視し, 連射度は高めにしました
  - コンティニューは無限にできます
  - ノーミスでもコンティニューしてもエンディングは同じなので, ササっと遊んでください
  - ラスボスは非常に硬いので, できるだけレベル アップして挑んでください
  - 乱数が多いのでゲーム性に難があります. 次回作は乱数を減らしたいです
  - ジョイスティック(AM7J のみ)対応
  - 制作期間:2021.07～10
  - ゲーム本体のエントリー ポイントは, 0x1e00 です

## テクニックなど

* プレーヤーの衝突判定は小さいので, サイド アタックができます

* 出来るだけ効率良くアイテムを取るには
  - 左右端では倒さない! アイテムが画面外に出てしまうことがあります
  - アイテムは一度に 32 個迄しか管理しないので, 沢山表示してると敵を倒しても出なくなります. できるだけ早く回収しましょう

## EmuZ-700 でしか動作確認してません. 実機では確認してません

  - ちゃんと動きますか?
  - 速度は遅くなってませんか?
  - 三重和音の音色は綺麗に出てます?
  - NWK ロゴは正しく表示されてます?
  - ジョイスティックは反応しますか?

## 作ってみての感想など

  - 最初はシンプルなシューティングのつもりでしたが, 作ってるうちに仕様が変わっていきました.
    - 敵の種類が増え,
    - レベル アップの概念がついて,
    - 弾幕系になったりして
  - SE は作るのは楽でしたが, 曲作るのは面倒臭かったです.
    - MIDI からのコンバータを作ってからは, 打ち込みできるようになったので, かなり楽になりました
  - 思ったより速度が出ててたので, ゲーム制作に期待できそうです


## 技術的な話

* コンバーターやデータ作成等の類は全部 PHP で作成しました.
  - 依存リスト作成も gcc は使わずに PHP で書いてます
* MZ-700 は VRAM アクセスに大きなウエイトがかかるので, 仮想 VRAM から転送するようにしました
  - 仮想 VRAM から VRAM への転送は H-BLANK 中に行います. 1/60 秒かかってますが, それでも直接 VRAM に描くより速いです
  - V-BLANK を待つので, 1フレームは 1/60 単位で動作します. 実際は 2/60 ～ 4/60 sec で動作してます
* コンパイラは, 色々悩みましたが, Z88DK(SDCC) を採用しました
  - 余り高速なコードは生成されません(それでも FORM より速い)
  - 描画や衝突判定など, 重たい部分はインラインアセンブラ化してます
  - crt0 は試行錯誤で余計な機能を削り, static 変数の初期化まで削りました
* リンク時に組み込まれる除算以外は, 外部ライブラリは使ってません
  - sin, cos, atan はテーブル検索方式で低精度・高速です
  - 乱数は M 系列疑似乱数で, 線形合同法より高速です
  - 乗算はインライン展開させて使ってます
* 敵弾は疑似グラフィックを使って少し滑らかに動きます
* MZ-700 に刺さるジョイスティックは純正, ツクモ, AM7J の三種類ありますが,
  - ST-2 では, AM7J のみ対応しました
  - ジョイスティックをポートに挿してなくても無限ループにならないように, 小細工を入れてます
* 通常は 64KB フル RAM で動作します
  - モニター サブルーチンは使用してません
  - スタックは 4K 確保しましたが 1K で十分だったようです
* デバッグ時は, 8253 CH1 を処理時間計測タイマーとして利用しました
* 実験を兼ねてメインプログラムを圧縮してみました
  - Exomizer 3 は, 制作当時, 圧縮率と展開速度のバランスが取れてる圧縮ツールで, バイナリを約半分にしてくれました!
  - 圧縮前のバージョンが game/Game.mzt です
* サウンド
  - 効果音には優先順位を入れました. 賑やかになったと思います.
  - 効果音ソースは一か所に纏めた方がよかったかも
  - エンディング曲は 1 フレーズ作ったあと, 転調させてるだけです!

## ビルド

* make all, clean, release の他に, 依存関係リスト作成する depend があります
* clean しても mzt ファイルは消さないようにしました

## デバッグビルド版での動作

* コンパイル速度を優先し, 最適化しないので処理速度は遅いです
* 画面左下に現在の画面遷移と 1 フレームにかかった時間を表示します
* デモ プレイは STAGE 1 のみです(リリース版は STAGE 1 ～ 4 をループします)
* コンティニューしてもハイスコアは 0 になりません
* ポーズ時の画面が出ません. X キーでステップ動作できます

## 謝辞

* 三重和音のアルゴリズムのヒントをくれた ひゃあ。えふ氏
* 後ろで文句を言わずに堪えてくれた URANUS 氏
* 様々なツールやコードを提供してくれた皆様方
* ありがとうございました!
